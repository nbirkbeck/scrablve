<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <style>
    #left-panel {
        float: left;
    }
    #right-panel {
        float: left;
        width: 260px;
        height: 600px;
        border-left: 1px solid black;
        padding-left: 10px;
    }
    #button-panel {
        margin-top: 30px;
        padding-top: 30px;
    }
    #button-panel button {
        margin-top: 30px;
        margin-left: 240px
    }
    .item {
        float: left;
        font-weight: bold;
        width: 32px;
        height: 32px;
        border-left: 1px solid white;
        border-top: 1px solid white;
        border-right: 2px solid white;
        border-bottom: 2px solid white;
        text-align: center;
    }
    .item.placed {
        border-left: 1px solid gray;
        border-top: 1px solid gray;
        border-right: 2px solid black;
        border-bottom: 2px solid black;
        background: rgb(140, 140, 80);
    }
    .black-border {
        border: 1px solid black;
    }
    .item div.points {
        font-size: 7pt;
        position: relative;
        right: 1;
        bottom: 0;
        text-align: right;
    }
    .item > input {
        text-align: center;
        width: 32px;
        height: 32px;
        border: 0;
        background: rgba(140, 140, 80, 0);
    }
    .item > input:hover {
        background: rgba(140, 140, 80, 0.6);
        border-right: 1px solid gray;
        border-bottom: 1px solid gray;
    }
    .item > input.placed {
        background: rgba(140, 140, 80, 0.7);
        border-right: 1px solid gray;
        border-bottom: 1px solid gray;
    }

    .empty {
        background: rgb(223, 209, 183);
    }
    .double-word {
        background: rgb(243, 173, 186);
    }
    .double-letter {
        background: rgb(135, 225, 250);
    }
    .triple-word {
        background: rgb(243, 100, 115);
    }
    .triple-letter {
        background: rgb(25, 155, 200);
    }
    #letters {
        height: 40px;
    }
    #letters div.available {
        background: white;

    }
    #letters div.not-available {
        background: gray;
        color: white;
    }
    #letters-panel {
        margin-bottom: 10px;
    }
    #best-panel {
        width: 100%;
    }
    #log-panel {
        clear: both;
        width: 100%;
        height: 200px;
        border-top: 1px solid gray;
        padding-top: 10px;
        overflow-y: scroll;
    }
    
    #current-move-score {
        height: 112px;
        overflow-y: scroll;
    }
    #board {
        padding-left: 20px;
        padding-right: 40px;
    }

  </style>
</head>
<body>
  <div>
    <div>
      <div id="left-panel">
        <h3>
          player_id:<span id="player-id">?</span> game_id:<span id="game-id">?</span>
        </h3>

        <div id="board"></div>
        <div id="button-panel">
          <button id="send-button">Send</button>
        </div>
      </div>
      <div id="right-panel">
        <h3>Status</h3>
        <p>Score:&nbsp;<span id="scores"></span></p>
        <p>Status:&nbsp;<span id="status"></span></p>
        <p>Turn:&nbsp;<span id="whose-turn"></span></p>

        <div id="letters-panel">
          <p>Letters:</p>
          <div id="letters"></div>
        </div>

        <div style="border-top: 1px solid gray">
          Current move status:
          <div id="current-move-score"></div>
        </div>
        <div style="border-top: 1px solid gray">Placed: <span id="move-status"></span></div>
        
        <div id="cheat-panel">
          <p></p>
          <button id="show-best">Show Me The Best!</button>
          <div id="best-panel">
          </div>
        </div>
      </div>
      <div style="padding-top: 10px; margin-top: 10px; clear: both;" >
        <div id="log-panel"></div>
      </div>

    </div>
  </div>

  <script>
    var client;
    const POINT_MAP = [
       1, 3, 3,  2, 1, 4,  2, 4, 1,
        8, 5, 1,  3, 1, 1,  3, 10, 1,
        1, 1, 1,  4, 4, 8,  3, 10
    ];
    
    function load_args() {
        var url_params = window.location.href.split("?")[1].split("&");
        var args = {};
        for (var i = 0; i < url_params.length; ++i) {
            var sp = url_params[i].split("=");
            args[sp[0]] = sp[1];
        }
        console.log(args);
        var player_id = parseInt(args["player_id"]);
        var game_id = parseInt(args["game_id"]);
        var auto = parseInt(args["auto"]);
        $("#game-id").html(game_id);
        $("#player-id").html(player_id);
        console.log(`load args ${game_id} ${player_id}`);
        return {
            "gameId": game_id,
            "playerId": player_id,
            "auto": auto,
        };
    }

    function create_place_letter(textInput, i, j) {
        return (x) => {
            console.log(`${i} ${j} ${x}`);
            console.log(x);
            if (!client.placeLetter(i, j, textInput.val())) {
                console.log("cant place");
                textInput.val("");
            }
            client.checkValid();
            client.updateView();
        };
    }

    function create_board() {
        var board = $("#board");
        var items = [];
        for (var i = 0; i < 15; ++i) {
            var row = $("<div></div>");
            for (var j = 0; j < 15; ++j) {
                var textInput = $("<input maxlength=1></input>");
                var item = $("<div class='empty'></div>");
                item.append(textInput);
                textInput.change(create_place_letter(textInput, i, j));
                row.append(item);
                items.push(item);
            }
            board.append(row);
        }
        for (var i = 0; i < 15; ++i) {
            items[15 * i + i].attr('class', 'double-word');
            items[15 * (14 - i) + i].attr('class', 'double-word');
        }
        [[0,3], [3, 0], [2, 6], [6, 2], [3, 7], [7, 3], [6, 6]].forEach((coord) => {
            items[15 * coord[0] + coord[1]].attr('class', 'double-letter');
            items[15 * coord[0] + (14 - coord[1])].attr('class', 'double-letter');
            items[15 * (14 - coord[0]) + coord[1]].attr('class', 'double-letter');
            items[15 * (14 - coord[0]) + (14 - coord[1])].attr('class', 'double-letter');
        });

        [[1, 5], [5, 1], [5, 5]].forEach((coord) => {
            items[15 * coord[0] + coord[1]].attr('class', 'triple-letter');
            items[15 * coord[0]+ (14 - coord[1])].attr('class', 'triple-letter');
            items[15 * (14 - coord[0]) + coord[1]].attr('class', 'triple-letter');
            items[15 * (14 - coord[0]) + (14 - coord[1])].attr('class', 'triple-letter');
        });

        [[0, 0], [0, 7], [7, 0]].forEach((coord) => {
            items[15 * coord[0] + coord[1]].attr('class', 'triple-word');
            items[15 * coord[0] + (14 - coord[1])].attr('class', 'triple-word');
            items[15 * (14 - coord[0]) + coord[1]].attr('class', 'triple-word');
            items[15 * (14 - coord[0]) + (14 - coord[1])].attr('class', 'triple-word');
        });

        items.forEach((item) => (
            item.addClass('item')
        ));
    }

    var Client = function(gameId, playerId) {
        this.gameId = gameId;
        this.playerId = playerId;
        this.url = "";
        this.letters = [];
        this.availableLetters = [];
        this.ready = false;
        this.currentPlayer = -1;
        this.numPlayed = 0;
        this.board = [];
        this.candidatePositions = [];
        for (var i = 0; i < 15; i++) {
            var row = [];
            for (var j = 0; j < 15; ++j) {
                row.push(' ');
            }
            this.board.push(row);
        }
        this.logs = []
    };

    Client.prototype.sendStatus = function() {
        $.ajax({
            "type": "POST",
            "url": `${this.url}/api/send_status`,
            "data": JSON.stringify({
                "game_id": this.gameId,
                "player_id": this.playerId,
                "num_played": this.numPlayed,
            }),
            "dataType": "json",
        }).done((x) => {
            this.ready = x.ready;
            this.currentPlayer = x.current_player;
            if ("board_state" in x) {
                this.setBoardState(x.board_state);
            }
            if ("logs" in x) {
                for (var i in x.logs) {
                    this.logs.push(x.logs[i]);
                }
            }
            this.scores = x.scores;
            if ("num_played" in x) {
                this.numPlayed = x.num_played;
                console.log(this.numPlayed);
            }
            this.updateView();
        });
    };

    Client.prototype.joinGame = function() {
        $.ajax({
            "type": "POST",
            "url": `${this.url}/api/join_game`,
            "data": JSON.stringify({
                "game_id": this.gameId,
                "player_id": this.playerId,
            }),
            "dataType": "json",
        }).done((x) => {
            this.setLetters(x.letters);
            this.updateView();
        });
    };

    Client.prototype.getCandidatePositions = function() {
        $.ajax({
            "type": "POST",
            "url": `${this.url}/api/get_candidate_positions`,
            "data": JSON.stringify({
                "game_id": this.gameId,
                "player_id": this.playerId,
            }),
            "dataType": "json",
        }).done((x) => {
            var i = 0;
            this.candidatePositions = [];
            for (var i in x.positions) {
                this.candidatePositions.push(x.positions[i]);
            }
            this.updateBestPanel();
        });
    };

    Client.prototype.checkValid = function() {
        var valid = client.isCurrentMoveValid();
        if (!valid) {
            console.log('Word is not valid');
            return;
        }
        $.ajax({
            "type": "POST",
            "url": `${this.url}/api/score_placed_word`,
            "data": JSON.stringify({
                "game_id": this.gameId,
                "move": {
                    "i": valid[0][0],
                    "j": valid[0][1],
                    "direction": valid[1],
                    "word": valid[2],
                }
            }),
            "dataType": "json",
        }).done((x) => {
            if (x.status == "OK") {
                var details = "";
                for (var i in x.details) {
                    details += "&nbsp;&nbsp;" + x.details[i] + "<br>";
                }
                $("#current-move-score").html(`Current move score: ${x.score}<br>Details:<br>${details}`);
                
            } else {
                $("#current-move-score").html(`Current move is invalid`);
            }
        });

    };

    Client.prototype.makePlay = function() {
        var valid = client.isCurrentMoveValid();
        if (!valid) {
            console.log('Not valid');
            return;
        }
        $.ajax({
            "type": "POST",
            "url": `${this.url}/api/move`,
            "data": JSON.stringify({
                "game_id": this.gameId,
                "player_id": this.playerId,
                "move": {
                    "i": valid[0][0],
                    "j": valid[0][1],
                    "direction": valid[1],
                    "word": valid[2],
                }
            }),
            "dataType": "json",
        }).done((x) => {
            // TODO: check validity
            console.log('Made move response');
            console.log(x);
            if ("letters" in x) {
                this.setLetters(x.letters);
            }
            this.scores = x.scores;
            if ("board_state" in x) {
                this.setBoardState(x.board_state);
            }
            this.updateView();
            this.sendStatus();
        });
    };

    Client.prototype.placeLetter = function(i, j, letter) {
        console.log('place letter:', i, j, letter);
        for (var k in this.letters) {
            if (this.availableLetters[k].length > 0 &&
                this.availableLetters[k][0] == i &&
                this.availableLetters[k][1] == j) {
                this.availableLetters[k] = [];
                break;
            }
        }

        for (var k in this.letters) {
            if (this.availableLetters[k].length > 0) continue;
            if (this.letters[k] == letter) {
                this.availableLetters[k] = [i, j];
                return true;
            }
        }
        return false;
    };

    Client.prototype.isCurrentMoveValid = function() {
        var minPos = [15, 15];
        var maxPos = [0, 0];
        var placed = {};
        for (var i in this.letters) {
            if (this.availableLetters[i].length > 0) {
                var pos = this.availableLetters[i];
                minPos[0] = Math.min(minPos[0], pos[0]);
                minPos[1] = Math.min(minPos[1], pos[1]);
                maxPos[0] = Math.max(maxPos[0], pos[0]);
                maxPos[1] = Math.max(maxPos[1], pos[1]);
                if (!placed.hasOwnProperty(pos[0])) {
                    placed[pos[0]] = {};
                }
                placed[pos[0]][pos[1]] = this.letters[i];
            }
        }
        var size = [
            maxPos[0] - minPos[0],
            maxPos[1] - minPos[1]
        ];
        if (!(size[0] == 0 || size[1] == 0)) return null;

        if (size[0] > 0) dir = 0;
        else dir = 1;
        var pos = [minPos[0], minPos[1]];
        var word = '';
        while (pos[dir] <= maxPos[dir]) {
            if (placed.hasOwnProperty(pos[0]) &&
                placed[pos[0]].hasOwnProperty(pos[1])) {
                word += placed[pos[0]][pos[1]];
            } else {
                word += this.board[pos[0]][pos[1]];
            }
            pos[dir] += 1;
        }
        if (word.indexOf(' ') >= 0) return null;

        return [minPos, dir, word];
    };

    Client.prototype.setBoardState = function(state) {
        var rows = state.split('\n');
        var board = $("#board");
        for (var i in rows) {
            var boardRow = $(board.children()[i]);
            for (var j = 0; j < 15; ++j) {
                this.board[i][j] = rows[i][j];
                if (rows[i][j] != ' ') {
                    var boardItem = $(boardRow.children()[j]);
                    const points = POINT_MAP[
                        Math.min(Math.max(0, rows[i][j].charCodeAt(0) - 'a'.charCodeAt(0)), 26)];
                    boardItem.html(rows[i][j] + `<div class='points'>${points}</div>`);
                    boardItem.addClass("placed");
                }
            }
        }
        console.log('board state');
        console.log(state);
    };

    Client.prototype.setLetters = function(letters) {
        this.availableLetters = [];
        for (var i in letters) {
            this.availableLetters.push([]);
        }
        this.letters = letters.map((x) => x[0]);
        this.candidatePositions = [];
        
        this.updateView();
        this.updateBestPanel();
    };

    Client.prototype.updateView = function() {
        $("#letters").html("");
        for (var i in this.letters) {
            const points = POINT_MAP[Math.min(Math.max(0, this.letters[i].charCodeAt(0) - 'a'.charCodeAt(0)), 26)];
            var letter = $(`<div>${this.letters[i]}<div class='points'>${points}</div></div>`);
            letter.addClass("item");
            letter.addClass("placed");
            if (this.availableLetters[i].length > 0) {
                letter.addClass("not-available")
            } else {
                letter.addClass("available")
            }
            $("#letters").append(letter);
        }

        $("#status").html(this.ready ? "Ready" : "Waiting");
        var scores = "";
        for (var i in this.scores) {
            scores += `<br>&nbsp;&nbsp; Player${i}: ${this.scores[i]}`;
        }
        $("#scores").html(scores);
        if (this.currentPlayer >= 0) {
            $("#whose-turn").html(`Other Player (#${this.currentPlayer})`);
            if (this.currentPlayer == this.playerId) {
                $("#whose-turn").html(`<b>Your turn!</b>`);
            }
        }
        if (this.currentPlayer == this.playerId) {
            $("#send-button").show();
            $("input").prop("disabled", false);
        } else {
            $("#send-button").hide();
            $("input").prop("disabled", true);
        }

        $("input").each((index, x) => {
            x = $(x);
            if (x.val() != "") x.addClass("placed");
            else x.removeClass("placed");
        });
        
        var valid = client.isCurrentMoveValid();
        if (valid) {
            $("#move-status").html(valid[2]);
        } else {
            $("#move-status").html("");
        }

        $("#log-panel").empty();
        for (var i in this.logs) {
            $("#log-panel").append(this.logs[i] + "<br>");
        }

    };

    Client.prototype.updateBestPanel = function() {
        var bestPanel = "";
        for (var i in this.candidatePositions) {
            var p = this.candidatePositions[i];
            bestPanel += `<option value=${i}>${p[0]}@(${p[1]}, ${p[2]}, ${p[3]}) word=${p[4]}</option>`;
        }
        if (bestPanel) {
            $("#best-panel").html(`<select size=10>${bestPanel}</select>`);
        } else {
            $("#best-panel").html("");
        }
    };

    Client.prototype.showCandidate = function(i) {
        console.log("Candidate:", i);
        var board = $("#board");
        var cand = this.candidatePositions[i];
        
        for (var k in this.letters) {
            if (this.availableLetters[k].length > 0) {
                var i = this.availableLetters[k][0];
                var j = this.availableLetters[k][1];
                var item = $($(board.children()[i]).children()[j]);
                $(item.children("input")).val("");
                this.availableLetters[k] = [];
            }
        }
        

        var pos = [cand[1], cand[2]];
        var dir = cand[3];
        var word = cand[4];
        for (var k in word) {
            if (this.board[pos[0]][pos[1]] == ' ') {
                this.placeLetter(pos[0], pos[1], word[k]);

                var item = $($(board.children()[pos[0]]).children()[pos[1]]);
                $(item.children()[0]).val(word[k]);
            }
            pos[dir]++;
        }
        this.updateView();
        this.checkValid();
    };

    function setup() {
        var args = load_args();
        create_board();

        client = new Client(args.gameId, args.playerId);
        client.joinGame();
        client.sendStatus();

        $("#send-button").click((x) => (client.makePlay()));
        $("#show-best").click((x) => (client.getCandidatePositions()));
        $("#best-panel").change((x) => (client.showCandidate(parseInt($(x.target).val()))));
        setInterval(() => (client.sendStatus()), 2500);

        if (args.auto) {
            console.log("auto");
            setInterval(() => {
                if (client.playerId == client.currentPlayer) {
                    if (!client.candidatePositions.length) {
                        client.getCandidatePositions();
                    } else {
                        client.showCandidate(client.candidatePositions.length - 1);
                        setTimeout(() => client.makePlay(), 1500);

                    }
                }
            }, 3000);
        }
    }

    $(document).ready(setup);

    $(board).motion((x) => {
        console.log(x);
    });
  </script>
</body>
